<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>freesteam: zeroin.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.8 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>zeroin.h</h1><pre class="fragment"><div>00001 <span class="comment">/*</span>
00002 <span class="comment"></span>
00003 <span class="comment">freesteam - IAPWS-IF97 steam tables library</span>
00004 <span class="comment">Copyright (C) 2004-2005  John Pye</span>
00005 <span class="comment"></span>
00006 <span class="comment">This program is free software; you can redistribute it and/or</span>
00007 <span class="comment">modify it under the terms of the GNU General Public License</span>
00008 <span class="comment">as published by the Free Software Foundation; either version 2</span>
00009 <span class="comment">of the License, or (at your option) any later version.</span>
00010 <span class="comment"></span>
00011 <span class="comment">This program is distributed in the hope that it will be useful,</span>
00012 <span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00013 <span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
00014 <span class="comment">GNU General Public License for more details.</span>
00015 <span class="comment"></span>
00016 <span class="comment">You should have received a copy of the GNU General Public License</span>
00017 <span class="comment">along with this program; if not, write to the Free Software</span>
00018 <span class="comment">Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
00019 <span class="comment"></span>
00020 <span class="comment">*/</span>
00021 
00022 <span class="preprocessor">#ifndef ZEROINVISITOR_H</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#define ZEROINVISITOR_H</span>
00024 <span class="preprocessor"></span>
00025 <span class="preprocessor">#include "designbycontract.h"</span>
00026 
00027 <span class="preprocessor">#include &lt;iostream&gt;</span>
00028 <span class="preprocessor">#include &lt;cmath&gt;</span>
00029 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00030 
00031 <span class="preprocessor">#ifndef DBL_EPSILON</span>
00032 <span class="preprocessor"></span><span class="preprocessor">        #define DBL_EPSILON 2e-16</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00034 <span class="preprocessor"></span>
00036 
00077 <span class="keyword">template</span> &lt; <span class="keyword">class</span> Subject, <span class="keyword">class</span> Ordinate = <span class="keywordtype">double</span>, <span class="keyword">class</span> Abscissa = <span class="keywordtype">double</span> &gt;
<a name="l00078"></a><a class="code" href="class_zero_in.html">00078</a> <span class="keyword">class </span><a class="code" href="class_zero_in.html">ZeroIn</a> : <span class="keyword">public</span> <a class="code" href="class_design_by_contract.html">DesignByContract</a> {
00079 
00080     <span class="keyword">private</span>:
00081     Abscissa ax;                
00082     Abscissa bx;                
00083     Ordinate(Subject::*method) (<span class="keyword">const</span> Abscissa&amp;);       
00084     Abscissa tol;               
00085     Abscissa x;                 
00086     <span class="keywordtype">bool</span> issolved;
00087 
00088     Abscissa a, b, c;           
00089     Ordinate fa;                
00090     Ordinate fb;                
00091     Ordinate fc;                
00092 
00093     Subject *subject;
00094 
00095     <span class="keyword">public</span>:
00096 
00097     <a class="code" href="class_zero_in.html">ZeroIn</a>() {
00098             this-&gt;tol = 0.0 * Abscissa();
00099     }
00100 
<a name="l00102"></a><a class="code" href="class_zero_in.html#a1">00102</a>     <span class="keywordtype">void</span> <a class="code" href="class_zero_in.html#a1">setLowerBound</a>(<span class="keyword">const</span> Abscissa&amp; ax) {
00103             this-&gt;ax = ax;
00104     }
00105 
<a name="l00107"></a><a class="code" href="class_zero_in.html#a2">00107</a>     Abscissa <a class="code" href="class_zero_in.html#a2">getLowerBound</a>()<span class="keyword"> const </span>{
00108             <span class="keywordflow">return</span> ax;
00109     }
00110 
<a name="l00112"></a><a class="code" href="class_zero_in.html#a3">00112</a>     <span class="keywordtype">void</span> <a class="code" href="class_zero_in.html#a3">setUpperBound</a>(<span class="keyword">const</span> Abscissa&amp; bx) {
00113             this-&gt;bx = bx;
00114     }
00115 
<a name="l00117"></a><a class="code" href="class_zero_in.html#a4">00117</a>     Abscissa <a class="code" href="class_zero_in.html#a4">getUpperBound</a>()<span class="keyword"> const</span>{
00118             <span class="keywordflow">return</span> bx;
00119     }
00120 
<a name="l00122"></a><a class="code" href="class_zero_in.html#a5">00122</a>     <span class="keywordtype">void</span> <a class="code" href="class_zero_in.html#a5">setTolerance</a>(<span class="keyword">const</span> Abscissa&amp; tol) {
00123             this-&gt;tol = tol;
00124     }
00125 
00127 
<a name="l00135"></a><a class="code" href="class_zero_in.html#a6">00135</a>     <span class="keywordtype">void</span> <a class="code" href="class_zero_in.html#a6">setMethod</a>(Ordinate(Subject::*method) (<span class="keyword">const</span> Abscissa&amp;)) {
00136             this-&gt;method = method;
00137     }
00138 
00140 
<a name="l00183"></a><a class="code" href="class_zero_in.html#a7">00183</a>     <span class="keywordtype">void</span> <a class="code" href="class_zero_in.html#a7">visit</a>(Subject *subject) {
00184 
00185             <span class="comment">//cerr &lt;&lt; "Begin zeroin with lower bound " &lt;&lt; K_TO_C(getLowerBound()) &lt;&lt; "°C and upper bound " &lt;&lt; K_TO_C(getUpperBound()) &lt;&lt; endl;</span>
00186 
00187             this-&gt;subject = subject;
00188             this-&gt;issolved = <span class="keyword">false</span>;
00189 
00190             a = ax;
00191             b = bx;
00192             fa = ((*subject).*method) (a);
00193             fb = ((*subject).*method) (b);
00194             c = a;
00195             fc = fa;
00196 
00197                 <span class="keywordflow">if</span>(fa == 0.0 * Ordinate()){
00198                         fb=0.0 * Ordinate(); <span class="comment">// used by getError</span>
00199                         <span class="keywordflow">return</span>;
00200                 }
00201 
00202             <span class="comment">//  Main iteration loop</span>
00203 
00204             <span class="keywordflow">for</span> (;;) {
00205                     Abscissa prev_step = b - a;    
00206                     Abscissa tol_act;                
00207                     Abscissa p;                    
00208                     <span class="keywordtype">double</span> q;                      
00209                     Abscissa new_step;             
00210 
00211                     <span class="keywordflow">if</span> (fabs(fc) &lt; fabs(fb)) {
00212                             a = b;
00213                             b = c;
00214                             c = a;  <span class="comment">//  Swap data for b to be the best approximation</span>
00215                             fa = fb;
00216                             fb = fc;
00217                             fc = fa;
00218                     }
00219 
00220                     <span class="comment">// DBL_EPSILON is defined in math.h</span>
00221                     tol_act = 2.0* DBL_EPSILON * fabs(b) + tol / 2.0;
00222 
00223                     new_step = (c - b) / 2.0;
00224 
00225                     <span class="keywordflow">if</span> (fabs(new_step) &lt;= tol_act || fb == 0.0 * Ordinate()) {
00226                             this-&gt;issolved = <span class="keyword">true</span>;       <span class="comment">//  Acceptable approx. is found</span>
00227                             <span class="comment">//cerr &lt;&lt; "Best solution is b, f(b=" &lt;&lt; b &lt;&lt; ")=" &lt;&lt; fb &lt;&lt;",f(a="&lt;&lt;a&lt;&lt;")="&lt;&lt; fa &lt;&lt;endl;</span>
00228                             <span class="keywordflow">return</span>;
00229                     }
00230                     <span class="comment">//  Decide if the interpolation can be tried</span>
00231 
00232                     <span class="keywordflow">if</span> (fabs(prev_step) &gt;= tol_act   <span class="comment">// If prev_step was large enough and was in true direction,</span>
00233                         &amp;&amp; fabs(fa) &gt; fabs(fb))      <span class="comment">// Interpolatiom may be tried</span>
00234                     {
00235                             <span class="keyword">register</span> <span class="keywordtype">double</span> t1, t2;
00236                             Abscissa cb;
00237 
00238                             cb = c - b;
00239                             <span class="keywordflow">if</span> (a == c) {
00240                                     <span class="comment">// If we have only two distinct points</span>
00241                                     <span class="comment">// then only linear interpolation can be applied</span>
00242                                     t1 = fb / fa;
00243                                     p = cb * t1;
00244                                     q = 1.0 - t1;
00245                             } <span class="keywordflow">else</span> {
00246                                     <span class="comment">// Quadric inverse interpolation</span>
00247 
00248                                     q = fa / fc;
00249                                     t1 = fb / fc;
00250                                     t2 = fb / fa;
00251                                     p = t2 * (cb * q * (q - t1) - (b - a) * (t1 - 1.0));
00252                                     q = (q - 1.0) * (t1 - 1.0) * (t2 - 1.0);
00253                             }
00254                             <span class="keywordflow">if</span> (p &gt; 0.0 * Abscissa()) {
00255                                     <span class="comment">// p was calculated with the opposite sign; make p positive-</span>
00256                                     q = -q;     <span class="comment">// and assign possible minus to q</span>
00257                             } <span class="keywordflow">else</span> {
00258                                     p = -p;
00259                             }
00260 
00261                             <span class="keywordflow">if</span> (p &lt; (0.75 * cb * q - fabs(tol_act * q) / 2.0)
00262                                 &amp;&amp; p &lt; fabs(prev_step * q / 2.0)
00263                                ) {
00264                                     <span class="comment">// If b+p/q falls in [b,c] and</span>
00265                                     <span class="comment">// isn't too large it is accepted</span>
00266                                     new_step = p / q;
00267                             }
00268                             <span class="comment">// If p/q is too large then the bissection procedure can</span>
00269                             <span class="comment">// reduce [b,c] range to more extent</span>
00270                     }
00271 
00272                     <span class="keywordflow">if</span> (fabs(new_step) &lt; tol_act) {     <span class="comment">// Adjust the step to be not less</span>
00273                             <span class="keywordflow">if</span> (new_step &gt; 0.0 * Abscissa())    <span class="comment">// than tolerance</span>
00274                                     new_step = tol_act;
00275                             <span class="keywordflow">else</span>
00276                                     new_step = -tol_act;
00277                     }
00278 
00279                     a = b;
00280                     fa = fb;            <span class="comment">// Save the previous approx.</span>
00281                     b += new_step;
00282                     fb = ((*subject).*method) (b);      <span class="comment">//  Do step to a new approxim.</span>
00283 
00284                     <span class="keywordflow">if</span> ((fb &gt; 0.0 * Ordinate() &amp;&amp; fc &gt; 0.0 * Ordinate())
00285                         || (fb &lt; 0.0 * Ordinate() &amp;&amp; fc &lt; 0.0 * Ordinate())) {
00286                             c = a;
00287                             fc = fa;    <span class="comment">//  Adjust c for it to have a sign opposite to that of b</span>
00288                     }
00289             }
00290             <span class="comment">// (((we never arrive here)))</span>
00291     }
00292 
00293     <span class="keywordtype">bool</span> isSolved(<span class="keywordtype">void</span>)<span class="keyword"> const</span>{
00294             <span class="keywordflow">return</span> issolved;
00295     }
00296 
00297     <span class="keywordtype">bool</span> isSolved(<span class="keyword">const</span> Ordinate &amp;error) {
00298             <span class="keywordflow">if</span> (fabs(fb) &gt; error) {
00299                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00300             }
00301             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00302     }
00303 
00304     Abscissa getSolution(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{
00305             <span class="keywordflow">return</span> a;
00306     }
00307 
00308     Ordinate getError(<span class="keywordtype">void</span>)<span class="keyword"> const</span>{
00309             <span class="keywordflow">return</span> fb;
00310     }
00311 };
00312 
00313 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Tue Mar 8 14:05:29 2005 for freesteam by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.8 </small></address>
</body>
</html>
