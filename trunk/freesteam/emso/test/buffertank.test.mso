#*
	Tests for simple buffer tank model.
*#

using "buffertank";
using "exitloss";

#*
	Simulation of buffer take with fixed outlet flow rate = inlet flowrate.
	Volume of tank is varying.
	
	THIS FLOWSHEET WORKS
*#
FlowSheet BufferTankTest1
	
	DEVICES
	S1 as Stream_pT;
	TA as BufferTank;
	
	CONNECTIONS
	S1 to TA.In;
	
	SPECIFY	
	
	# Inlet state and flow rate
	S1.p = 2 * "atm";
	S1.T = (273.15 + 120) * "K";
	S1.mdot = 10 * "kg/s";
	
	# Inlet flow rate = outlet flow rate (volume is not constant)
	TA.Out.mdot = S1.mdot;

	INITIAL
	TA.T = (273.15 + 4) * "K";
	TA.V = 1 * "m^3";
	
	GUESS
	TA.Out.h = 104.9 * "kJ/kg";
	
	TA.rho = 997 * "kg/m^3";
	TA.H = 1* "m^3" * 104.9 * "kJ/kg" / (1000 * "kg/m^3");

	OPTIONS
	# mode="steady";
	differentiation="numeric";
	# outputLevel="all";
	time = [0 : 0.1 : 480] * "s";
end

#*
	Simple test of a buffer tank. Water flows in at
	a steady rate, and mixes with the water in the tank.
	
	The temperature of the water coming out at the
	outlet should gradually rise to equal the
	temperature of the water being pumped into the tank.

	THIS FLOWSHEET WORKS IN STEADY STATE
	BUT COMPLAINS ABOUT derivatives="symbolic" WHEN ATTEMPTING
	TO RUN TRANSIENT CASE.
*#
FlowSheet BufferTankTest2
	
	DEVICES
	S1 as Stream_pT;
	TA as BufferTank;
	
	CONNECTIONS
	S1 to TA.In;
	
	SPECIFY	
	
	# Inlet state and flow rate
	S1.p = 2 * "atm";
	S1.T = (273.15 + 120) * "K";
	S1.mdot = 10 * "kg/s";
	
	# Fixed tank volume
	TA.V = 1 * "m^3";

	INITIAL
	TA.T = (273.15 + 4) * "K";

	GUESS
	TA.Out.h = 104.9 * "kJ/kg";
	
	TA.rho = 997 * "kg/m^3";
	TA.H = 1* "m^3" * 104.9 * "kJ/kg" / (1000 * "kg/m^3");

	OPTIONS
	# mode="steady";
	differentiation="numeric";
	# outputLevel="all";
	time = [0 : 0.05 : 2] * "s";
end

#*
	FAILS: initial condition singular
*#
FlowSheet BufferTankTest3
	
	DEVICES
	S1 as Stream_pT;
	TA as BufferTank;
	EX as ExitLoss;
	S2 as Stream_pT;
	
	CONNECTIONS
	S1 to TA.In;
	TA.Out to EX.In;
	EX.Out to S2;
	
	SPECIFY	
	
	# Inlet state and flow rate
	S1.p = 2 * "atm";
	S1.T = (273.15 + 120) * "K";
	# S1.mdot = 10 * "kg/s";
	
	# Exit loss
	EX.C = 0.95;
	S2.p = 1 * "atm";

	TA.V = 1 * "m^3";

	INITIAL
	TA.Out.T = (273.15 + 4) * "K";

	GUESS
	TA.Out.h = 104.9 * "kJ/kg";
	
	TA.rho = 997 * "kg/m^3";
	TA.H = 1* "m^3" * 104.9 * "kJ/kg" / (1000 * "kg/m^3");

	OPTIONS
	mode="steady";
	differentiation="numeric";

	# outputLevel="all";
	time = [0 : 0.05 : 2] * "s";

end
