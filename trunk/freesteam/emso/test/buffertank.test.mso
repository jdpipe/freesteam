#*
	Tests for simple buffer tank model.
*#

using "buffertank";
using "exitloss";

#*
	Simulation of buffer take with fixed 
	outlet flow rate = inlet flowrate.
	
	Volume of tank is varying.
	
	THIS FLOWSHEET WORKS
*#
FlowSheet BufferTankTest1
	
	DEVICES
	S1 as Stream_pT;
	TA as BufferTank;
	
	CONNECTIONS
	S1 to TA.In;
	
	SPECIFY	
	
	# Inlet state and flow rate
	S1.p = 2 * "atm";
	S1.T = (273.15 + 120) * "K";
	S1.mdot = 10 * "kg/s";
	
	# Inlet flow rate = outlet flow rate (volume is not constant)
	TA.Out.mdot = S1.mdot;

	INITIAL
	TA.T = (273.15 + 4) * "K";
	TA.V = 1 * "m^3";
	
	OPTIONS
	# mode="steady";
	differentiation="numeric";
	
	# outputLevel="all";
	time = [0 : 1 : 480] * "s";
end

#*
	Test of 8 cascaded tanks

	THIS FLOWSHEET WORKS
*#
FlowSheet BufferTankTest2
	
	DEVICES
	S1 as Stream_pT;
	TA1 as BufferTank;
	TA2 as BufferTank;
	TA3 as BufferTank;
	TA4 as BufferTank;
	TA5 as BufferTank;
	TA6 as BufferTank;
	TA7 as BufferTank;
	TA8 as BufferTank;
		
	CONNECTIONS
	S1 to TA1.In;
	TA1.Out to TA2.In;
	TA2.Out to TA3.In;
	TA3.Out to TA4.In;
	TA4.Out to TA5.In;
	TA5.Out to TA6.In;
	TA6.Out to TA7.In;
	TA7.Out to TA8.In;
	
	SPECIFY	
	
	# Inlet state and flow rate
	S1.p = 2 * "atm";
	S1.T = (273.15 + 120) * "K";
	S1.mdot = 10 * "kg/s";
	
	# Inlet flow rate = outlet flow rate (volume is not constant)
	TA1.In.mdot = TA1.Out.mdot;
	TA2.In.mdot = TA2.Out.mdot;
	TA3.In.mdot = TA3.Out.mdot;
	TA4.In.mdot = TA4.Out.mdot;
	TA5.In.mdot = TA5.Out.mdot;
	TA6.In.mdot = TA6.Out.mdot;
	TA7.In.mdot = TA7.Out.mdot;
	TA8.In.mdot = TA8.Out.mdot;
	
	INITIAL
	TA1.T = (273.15 + 4) * "K";
	TA1.V = 1 * "m^3";

	TA2.T = (273.15 + 4) * "K";
	TA2.V = 1 * "m^3";

	TA3.T = (273.15 + 4) * "K";
	TA3.V = 1 * "m^3";

	TA4.T = (273.15 + 4) * "K";
	TA4.V = 1 * "m^3";

	TA5.T = (273.15 + 4) * "K";
	TA5.V = 1 * "m^3";

	TA6.T = (273.15 + 4) * "K";
	TA6.V = 1 * "m^3";

	TA7.T = (273.15 + 4) * "K";
	TA7.V = 1 * "m^3";

	TA8.T = (273.15 + 4) * "K";
	TA8.V = 1 * "m^3";

	OPTIONS
	# mode="steady";
	differentiation="numeric";
	# outputLevel="all";
	time = [0 : 10: 480] * "s";
end


#*
	Test of 8 cascaded tanks in a loop, half with water
	and half with steam

	Mass flow rate fixed throughout

	DOESN'T WORK
*#
FlowSheet BufferTankLoopTest
	
	DEVICES
	TA1 as BufferTank;
	TA2 as BufferTank;
	TA3 as BufferTank;
	TA4 as BufferTank;
	TA5 as BufferTank;
	TA6 as BufferTank;
	TA7 as BufferTank;
	TA8 as BufferTank;
		
	CONNECTIONS
	TA1.Out to TA2.In;
	TA2.Out to TA3.In;
	TA3.Out to TA4.In;
	TA4.Out to TA5.In;
	TA5.Out to TA6.In;
	TA6.Out to TA7.In;
	TA7.Out to TA8.In;
	
	SPECIFY	
	TA1.In.mdot = 1 * "kg/s";
	TA1.In.p = TA8.Out.p;
	TA1.In.h = TA8.Out.h;
	TA8.Out.mdot = 1 * "kg/s";
	
	# Inlet flow rate = outlet flow rate (volume is not constant)
	TA1.In.mdot = TA1.Out.mdot;
	TA2.In.mdot = TA2.Out.mdot;
	TA3.In.mdot = TA3.Out.mdot;
	TA4.In.mdot = TA4.Out.mdot;
	TA5.In.mdot = TA5.Out.mdot;
	TA6.In.mdot = TA6.Out.mdot;
	TA7.In.mdot = TA7.Out.mdot;
	TA8.In.mdot = TA8.Out.mdot;
	
	INITIAL
	# Inlet state and flow rate
	
	TA1.T = (273.15 + 4) * "K";
	TA1.V = 1 * "m^3";

	TA2.T = (273.15 + 4) * "K";
	TA2.V = 1 * "m^3";

	TA3.T = (273.15 + 4) * "K";
	TA3.V = 1 * "m^3";

	TA4.T = (273.15 + 4) * "K";
	TA4.V = 1 * "m^3";

	TA5.T = (273.15 + 200) * "K";
	TA5.V = 1 * "m^3";

	TA6.T = (273.15 + 200) * "K";
	TA6.V = 1 * "m^3";

	TA7.T = (273.15 + 200) * "K";
	TA7.V = 1 * "m^3";

	TA8.T = (273.15 + 200) * "K";
	TA8.V = 1 * "m^3";

	OPTIONS
	# mode="steady";
	differentiation="numeric";
	# outputLevel="all";
	time = [0 : 10: 480] * "s";
end



#*
	Simple test of a buffer tank. Water flows in at
	a steady rate, and mixes with the water in the tank.
	
	The temperature of the water coming out at the
	outlet should gradually rise to equal the
	temperature of the water being pumped into the tank.

	THIS FLOWSHEET WORKS IN STEADY STATE
	BUT COMPLAINS ABOUT derivatives="symbolic" WHEN ATTEMPTING
	TO RUN TRANSIENT CASE.
*#
#*
FlowSheet BufferTankTest3
	
	DEVICES
	S1 as Stream_pT;
	TA as BufferTank;
	
	CONNECTIONS
	S1 to TA.In;
	
	SPECIFY	
	
	# Inlet state and flow rate
	S1.p = 2 * "atm";
	S1.T = (273.15 + 120) * "K";
	S1.mdot = 10 * "kg/s";
	
	# Fixed tank volume
	TA.V = 1 * "m^3";

	INITIAL
	TA.T = (273.15 + 4) * "K";

	GUESS
	TA.Out.h = 104.9 * "kJ/kg";
	
	TA.rho = 997 * "kg/m^3";
	TA.U = 1* "m^3" * 104.9 * "kJ/kg" / (1000 * "kg/m^3");

	OPTIONS
	# mode="steady";
	differentiation="numeric";
	# outputLevel="all";
	time = [0 : 0.05 : 2] * "s";
end
*#
#*
	FAILS: initial condition singular
*#
#*
FlowSheet BufferTankTest4
	
	DEVICES
	S1 as Stream_pT;
	TA as BufferTank;
	EX as ExitLoss;
	S2 as Stream_pT;
	
	CONNECTIONS
	S1 to TA.In;
	TA.Out to EX.In;
	EX.Out to S2;
	
	SPECIFY	
	
	# Inlet state and flow rate
	S1.p = 2 * "atm";
	S1.T = (273.15 + 120) * "K";
	# S1.mdot = 10 * "kg/s";
	
	# Exit loss
	EX.C = 0.95;
	S2.p = 1 * "atm";

	TA.V = 1 * "m^3";

	INITIAL
	TA.Out.T = (273.15 + 4) * "K";

	GUESS
	TA.Out.h = 104.9 * "kJ/kg";
	
	TA.rho = 997 * "kg/m^3";
	TA.H = 1* "m^3" * 104.9 * "kJ/kg" / (1000 * "kg/m^3");

	OPTIONS
	mode="steady";
	differentiation="numeric";

	# outputLevel="all";
	time = [0 : 0.05 : 2] * "s";

end
*#
#*
FlowSheet BufferTank2Test1
	
	DEVICES
	TA as BufferTank2;
	S1 as Stream_pT;
	
	CONNECTIONS
	S1 to TA.In;
	
	SET
	TA.V = 1 * "m^3";
	
	SPECIFY
	S1.p = 1 * "bar";
	S1.T = (50 + 273.15) * "K";
	S1.mdot = 1 * "kg/s";

	INITIAL
	TA.T = (20 + 273.15) * "K";
	
	OPTIONS
	# mode="steady";
	differentiation="numeric";
	time = [0 : 10 : 1000];
	
end
*#

FlowSheet ComeOnJustWorkYouBastard
	PARAMETERS
	freesteam as CalcObject(File="emsofreesteam");
	mdot1 as MassFlowRate;
	V as Volume;
	h1 as SpecificEnthalpy;
	p as Pressure;
	
	VARIABLES
	M as Mass;
	U as Energy;
	mdot2 as MassFlowRate;
	rho as Density;
	u as SpecificInternalEnergy;
	h2 as SpecificEnthalpy;
		
	EQUATIONS
	mdot1 - mdot2 = diff(M);
	M = rho * V;
	h1 * mdot1 - h2 * mdot2 = diff(U);
	U = M * u;
	rho = freesteam.rho_pu(p, u);
	h2 = u + p/rho;
		
	SET
	p = 1 * "bar";
	h1 = 1000 * "kJ/kg";
	mdot1 = 1 * "kg/s";
	V = 1 * "m^3";
	
	INITIAL
	h2 = 500 * "kJ/kg";
	
	OPTIONS
	differentiation="symbolic";
	outputLevel="all";
end

FlowSheet BufferTankAfterPantelides
	PARAMETERS
	freesteam as CalcObject(File="emsofreesteam");
	mdot1 as MassFlowRate;
	V as Volume;
	h1 as SpecificEnthalpy;
	p as Pressure;
	
	VARIABLES
	M as Mass;
	U as Energy;
	mdot2 as MassFlowRate;
	rho as Density;
	u as SpecificInternalEnergy;
	h2 as SpecificEnthalpy;
		
	EQUATIONS
	mdot1 - mdot2 = diff(M);
	#M = rho * V;
	h1 * mdot1 - h2 * mdot2 = diff(U);
	#U = M * u;
	
	#rho = freesteam.rho_pu(p, u);
	h2 = u + p/rho;
	
	diff(M) = diff(rho) * V;
	diff(U) = diff(M) * u + diff(u) * M;
	diff(rho) = diff(u) * (freesteam.rho_pu(p,u)/u);
		
	SET
	p = 1 * "bar";
	h1 = 1000 * "kJ/kg";
	mdot1 = 1 * "kg/s";
	V = 1 * "m^3";
	
	INITIAL
	u = 2800 * "kJ/kg";
	
	M = rho * V;
	U = M * u;
	rho = freesteam.rho_pu(p,u);
	
	
	OPTIONS
	differentiation="numeric";
	outputLevel="all";
end

FlowSheet BufferTankExplicitFixedVolume
	
	PARAMETERS
	freesteam1 as CalcObject(File="emsofreesteam");
	mdot1 as MassFlowRate;
	V as Volume;
	h1 as SpecificEnthalpy;
	p as Pressure;

	VARIABLES
	M as Mass;
	U as Energy(Upper=1e10);
	mdot2 as MassFlowRate;
	v as Density(Default=0.01,Unit="m^3/kg");
	u as SpecificInternalEnergy(Default=1500,Unit="kJ/kg");
	h2 as SpecificEnthalpy(Default=1500,Unit="kJ/kg");
	# T as Temperature;
	
	v1 as SpecificVolume;
	
	EQUATIONS
	mdot1 - mdot2 = diff(M);
	v = V / M;
	h1 * mdot1 - h2 * mdot2 = diff(U);
	u = U / M;
	mdot2 * v = mdot1 * v1;
	h2 = u + p * v;
	
	SPECIFY
	v1 = freesteam1.v_ph(p,h1);
	# T = freesteam2.T_ph(p,h2);
	
	SET
	p = 1 * "bar";
	h1 = 313.9 * "kJ/kg";
	mdot1 = 10 * "kg/s";
	V = 1 * "m^3";
	
	INITIAL
	v = 1/997 * "m^3/kg";
	u = 104.8 * "kJ/kg";
	
	OPTIONS
	differentiation="numeric";
	outputLevel="medium";
	time = [0 : 1 : 1000 ] * "s";
end

FlowSheet BufferTank4Test
	
	DEVICES
	TA as BufferTank4;
	S1 as Stream_pT;
	
	CONNECTIONS
	S1 to TA.In;
	
	SET
	TA.V = 1 * "m^3";
	
	SPECIFY
	S1.p = 1 * "bar";
	S1.T = (25+273.15) * "K";
	S1.mdot = 10 * "kg/s";
	
	INITIAL
	TA.v = 1/997 * "m^3/kg";
	TA.u = 600 * "kJ/kg";
	
	OPTIONS
	differentiation="numeric";
	outputLevel="high";
	time = [0 : 2 : 500 ] * "s";
	
end

FlowSheet BufferTank4Test2
	
	DEVICES
	TA1 as BufferTank4;
	TA2 as BufferTank4;
	TA3 as BufferTank4;
	TA4 as BufferTank4;
	S1 as Stream_pT;
	
	CONNECTIONS
	S1 to TA1.In;
	TA1.Out to TA2.In;
	TA2.Out to TA3.In;
	TA3.Out to TA4.In;
	
	SET
	TA1.V = 1 * "m^3";
	TA2.V = 1 * "m^3";
	TA3.V = 1 * "m^3";
	TA4.V = 1 * "m^3";
	
	SPECIFY
	S1.p = 1 * "bar";
	S1.T = (25+273.15) * "K";
	S1.mdot = 10 * "kg/s";
	
	INITIAL
	TA1.v = 1/997 * "m^3/kg";
	TA1.u = 600 * "kJ/kg";
	TA2.v = 1/997 * "m^3/kg";
	TA2.u = 600 * "kJ/kg";
	TA3.v = 1/997 * "m^3/kg";
	TA3.u = 600 * "kJ/kg";
	TA4.v = 1/997 * "m^3/kg";
	TA4.u = 600 * "kJ/kg";
	
	OPTIONS
	differentiation="numeric";
	outputLevel="low";
	time = [0 : 0.2 : 500 ] * "s";
	
end
